
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>HandySpark &#8212; HandySpark 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to HandySpark’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <a class="reference external image-reference" href="https://travis-ci.org/dvgodoy/handyspark"><img alt="Build Status" src="https://travis-ci.org/dvgodoy/handyspark.svg?branch=master" /></a>
<div class="section" id="handyspark">
<h1>HandySpark<a class="headerlink" href="#handyspark" title="Permalink to this headline">¶</a></h1>
<div class="section" id="bringing-pandas-like-capabilities-to-spark-dataframes">
<h2>Bringing pandas-like capabilities to Spark dataframes!<a class="headerlink" href="#bringing-pandas-like-capabilities-to-spark-dataframes" title="Permalink to this headline">¶</a></h2>
<p><em>HandySpark</em> is a package designed to improve <em>PySpark</em> user experience, especially when it comes to <em>exploratory data analysis</em> , including <em>visualization</em> capabilities!</p>
<p>It makes fetching data or computing statistics for columns really easy, returning <em>pandas objects</em> straight away.</p>
<p>It also leverages on the recently released <em>pandas UDFs</em> in Spark to allow for an out-of-the-box usage of common <em>pandas functions</em> in a Spark dataframe.</p>
<p>Moreover, it introduces the <em>stratify</em> operation, so users can perform more sophisticated analysis, imputation and outlier detection on stratified data without incurring in very computationally expensive <em>groupby</em> operations.</p>
<p>Finally, it brings the long missing capability of <em>plotting</em> data while retaining the advantage of performing distributed computation (unlike many tutorials on the internet, which just convert the whole dataset to pandas and then plot it - don’t ever do that!).</p>
</div>
<div class="section" id="google-colab">
<h2>Google Colab<a class="headerlink" href="#google-colab" title="Permalink to this headline">¶</a></h2>
<p>Eager to try it out right away? Don’t wait any longer!</p>
<p>Open the notebook directly on Google Colab and try it yourself:</p>
<ul class="simple">
<li><a class="reference external" href="https://colab.research.google.com/github/dvgodoy/handyspark/blob/master/notebooks/Exploring_Titanic.ipynb">Exploring Titanic</a></li>
</ul>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>To install <em>HandySpark</em> from <a class="reference external" href="https://pypi.org/project/handyspark/">PyPI</a>, just type:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">handyspark</span>
</pre></div>
</div>
</div>
<div class="section" id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<p>You can find the full documentations <a class="reference external" href="http://dvgodoy.github.com/handyspark">here</a>.</p>
</div>
<div class="section" id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>To use <em>HandySpark</em> , all you need to do is import the package and, after loading your data into a Spark dataframe, call the <em>toHandy()</em> method to get your own <em>HandyFrame</em> :</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">handyspark</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">sdf</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="s1">&#39;./tests/rawdata/train.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">hdf</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">toHandy</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="fetching-and-plotting-data">
<h3>Fetching and plotting data<a class="headerlink" href="#fetching-and-plotting-data" title="Permalink to this headline">¶</a></h3>
<p>Now you can easily fetch data as if you were using pandas, just use the <em>cols</em> object from your <em>HandyFrame</em> :</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<p>It should return a pandas Series object:</p>
<p>If you include a list of columns, it will return a pandas DataFrame.</p>
<p>Due to the distributed nature of data in Spark, it is only possible to fetch the top rows of any given <em>HandyFrame</em>.</p>
<p>Using <em>cols</em> you have access to several pandas-like column and DataFrame based methods implemented in Spark:</p>
<ul class="simple">
<li>min / max / median / q1 / q3 / stddev / mode</li>
<li>nunique</li>
<li>value_counts</li>
<li>corr</li>
<li>hist</li>
<li>boxplot</li>
<li>scatterplot</li>
</ul>
<p>For instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also make some plots:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">hdf</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">hdf</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">hdf</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Fare&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">hdf</span><span class="o">.</span><span class="n">cols</span><span class="p">[[</span><span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<a class="reference external image-reference" href="/images/cols_plot.png"><img alt="cols plots" src="images/cols_plot.png" /></a>
<p>Handy, right (pun intended!)? But things can get <em>even more</em> interesting if you use <em>stratify</em> !</p>
</div>
<div class="section" id="stratify">
<h3>Stratify<a class="headerlink" href="#stratify" title="Permalink to this headline">¶</a></h3>
<p>Stratifying a HandyFrame means using a <em>split-apply-combine</em> approach. It will first split your HandyFrame according to the specified (discrete) columns, then it will apply some function to each stratum of data and finally combine the results back together.</p>
<p>This is better illustrated with an example - let’s try the stratified version of our previous <code class="docutils literal"><span class="pre">value_counts</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf</span><span class="o">.</span><span class="n">stratify</span><span class="p">([</span><span class="s1">&#39;Pclass&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<p>Cool, isn’t it? Besides, under the hood, not a single <em>group by</em> operation was performed - everything is handled using filter clauses! So, <em>no data shuffling</em> !</p>
<p>What if you want to <em>stratify</em> on a column containing continuous values? No problem!</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf</span><span class="o">.</span><span class="n">stratify</span><span class="p">([</span><span class="s1">&#39;Sex&#39;</span><span class="p">,</span> <span class="n">Bucket</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<p>You can use either <em>Bucket</em> or <em>Quantile</em> to discretize your data in any given number of bins!</p>
<p>What about <em>plotting</em> it? Yes, <em>HandySpark</em> can handle that as well!</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf</span><span class="o">.</span><span class="n">stratify</span><span class="p">([</span><span class="s1">&#39;Sex&#39;</span><span class="p">,</span> <span class="n">Bucket</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference external image-reference" href="/images/stratified_hist.png"><img alt="stratified hist" src="images/stratified_hist.png" /></a>
</div>
<div class="section" id="handling-missing-data">
<h3>Handling missing data<a class="headerlink" href="#handling-missing-data" title="Permalink to this headline">¶</a></h3>
<p><em>HandySpark</em> makes it very easy to spot and fill missing values. To figure if there are any missing values, just use <em>isnull</em> :</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ratio</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Ok, now you know there are 3 columns with missing values: <code class="docutils literal"><span class="pre">Age</span></code>, <code class="docutils literal"><span class="pre">Cabin</span></code> and <code class="docutils literal"><span class="pre">Embarked</span></code>. It’s time to fill those values up! But, let’s skip <code class="docutils literal"><span class="pre">Cabin</span></code>, which has 77% of its values missing!</p>
<p>So, <code class="docutils literal"><span class="pre">Age</span></code> is a continuous variable, while <code class="docutils literal"><span class="pre">Embarked</span></code> is a categorical variable. Let’s start with the latter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_filled</span> <span class="o">=</span> <span class="n">hdf</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">categorical</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p><em>HandyFrame</em> has a <em>fill</em> method which takes up to 3 arguments:</p>
<ul class="simple">
<li>categorical: a list of categorical variables</li>
<li>continuous: a list of continuous variables</li>
<li>strategy: which strategy to use for each one of the continuous variables (either <code class="docutils literal"><span class="pre">mean</span></code> or <code class="docutils literal"><span class="pre">median</span></code>)</li>
</ul>
<p>Categorical variables use a <code class="docutils literal"><span class="pre">mode</span></code> strategy by default.</p>
<p>But you do not need to stick with the basics anymore… you can fancy it up using <em>stratify</em> together with <em>fill</em> :</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_filled</span> <span class="o">=</span> <span class="n">hdf_filled</span><span class="o">.</span><span class="n">stratify</span><span class="p">([</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Sex&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">continuous</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">],</span> <span class="n">strategy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>How do you know which values are being used? Simple enough:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_filled</span><span class="o">.</span><span class="n">statistics_</span>
</pre></div>
</div>
<p>There you go! The filter clauses and the corresponding imputation values!</p>
<p>But there is <em>more</em> - once you’re with your imputation procedure, why not generate a <em>custom transformer</em> to do that for you, either on your test set or in production?</p>
<p>You only need to call the <em>imputer</em> method of the <em>transformer</em> object that every <em>HandyFrame</em> has:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">imputer</span> <span class="o">=</span> <span class="n">hdf_filled</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">imputer</span><span class="p">()</span>
</pre></div>
</div>
<p>In the example above, <em>imputer</em> is now a full-fledged serializable PySpark transformer! What does that mean? You can use it in your <em>pipeline</em> and <em>save / load</em> at will :-)</p>
</div>
<div class="section" id="detecting-outliers">
<h3>Detecting outliers<a class="headerlink" href="#detecting-outliers" title="Permalink to this headline">¶</a></h3>
<p>Second only to the problem of missing data, outliers can pose a challenge for training machine learning models.</p>
<p><em>HandyFrame</em> to the rescue, with its <em>outliers</em> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_filled</span><span class="o">.</span><span class="n">outliers</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;tukey&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
<p>Currently, only <a class="reference external" href="https://en.wikipedia.org/wiki/Outlier#Tukey's_fences">*Tukey’s*</a> method is available (I am working on Mahalanobis distance!). This method takes an optional <em>k</em> argument, which you can set to larger values (like 3) to allow for a more loose detection.</p>
<p>The good thing is, now we can take a peek at the data by plotting it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">hdf_filled</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Parch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">hdf_filled</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;SibSp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">hdf_filled</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">hdf_filled</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Fare&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference external image-reference" href="/images/outliers.png"><img alt="outliers" src="images/outliers.png" /></a>
<p>Let’s focus on the <code class="docutils literal"><span class="pre">Fare</span></code> column - what can we do about it? Well, we could use Tukey’s fences to, er… <em>fence</em> the outliers :-)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_fenced</span> <span class="o">=</span> <span class="n">hdf_filled</span><span class="o">.</span><span class="n">fence</span><span class="p">([</span><span class="s1">&#39;Fare&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Which values were used, you ask?</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_fenced</span><span class="o">.</span><span class="n">fences_</span>
</pre></div>
</div>
<p>It works quite similarly to the <em>fill</em> method and, I hope you guessed, it <em>also</em> gives you the ability to create the corresponding <em>custom transformer</em> :-)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fencer</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">fencer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="pandas-and-more-pandas">
<h3>Pandas and more pandas!<a class="headerlink" href="#pandas-and-more-pandas" title="Permalink to this headline">¶</a></h3>
<p>With <em>HandySpark</em> you can feel <em>almost</em> as if you were using traditional pandas :-)</p>
<p>To gain access to the whole suite of available pandas functions, you need to leverage the <em>pandas</em> object of your <em>HandyFrame</em> :</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">some_ports</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">pandas</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">])</span>
<span class="n">some_ports</span>
</pre></div>
</div>
<p>In the example above, <em>HandySpark</em> treats the <code class="docutils literal"><span class="pre">Embarked</span></code> column as if it were a pandas Series and, therefore, you may call its <em>isin</em> method!</p>
<p>But, remember Spark has <em>lazy evaluation</em> , so the result is a <em>column expression</em> which leverages the power of <em>pandas UDFs</em> (provived that PyArrow is installed, otherwise it will fall back to traditional UDFs).</p>
<p>The only thing left to do is to actually <em>assign</em> the results to a new column, right?</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_fenced</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">is_c_or_q</span><span class="o">=</span><span class="n">some_ports</span><span class="p">)</span>
<span class="c1"># What&#39;s in there?</span>
<span class="n">hdf_fenced</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;is_c_or_q&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<p>You got that right! <em>HandyFrame</em> has a very convenient <em>assign</em> method, just like in pandas!</p>
<p>It does not get much easier than that :-) There are several column methods available already:</p>
<ul class="simple">
<li>betweeen / between_time</li>
<li>isin</li>
<li>isna / isnull</li>
<li>notna / notnull</li>
<li>abs</li>
<li>clip / clip_lower / clip_upper</li>
<li>replace</li>
<li>round / truncate</li>
<li>tz_convert / tz_localize</li>
</ul>
<p>And this is not all! Both specialized <em>str</em> and <em>dt</em> objects from pandas are available as well!</p>
<p>For instance, if you want to find if a given string contains another substring?</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">col_mrs</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">pandas</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sub</span><span class="o">=</span><span class="s1">&#39;Mrs.&#39;</span><span class="p">)</span>
<span class="n">hdf_fenced</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">is_mrs</span><span class="o">=</span><span class="n">col_mrs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference external image-reference" href="/images/is_mrs.png"><img alt="is mrs" src="images/is_mrs.png" /></a>
<p>There are many, many more available methods:</p>
<p><em>String methods</em> :</p>
<ol class="arabic simple">
<li>contains</li>
<li>startswith / endswitch</li>
<li>match</li>
<li>isalpha / isnumeric / isalnum / isdigit / isdecimal / isspace</li>
<li>islower / isupper / istitle</li>
<li>replace</li>
<li>repeat</li>
<li>join</li>
<li>pad</li>
<li>slice / slice_replace</li>
<li>strip / lstrip / rstrip</li>
<li>wrap / center / ljust / rjust</li>
<li>translate</li>
<li>get</li>
<li>normalize</li>
<li>lower / upper / capitalize / swapcase / title</li>
<li>zfill</li>
<li>count</li>
<li>find / rfind</li>
<li>len</li>
</ol>
<p><em>Date / Datetime methods</em> :</p>
<ol class="arabic simple">
<li>is_leap_year / is_month_end / is_month_start / is_quarter_end / is_quarter_start / is_year_end / is_year_start</li>
<li>strftime</li>
<li>tz / time / tz_convert / tz_localize</li>
<li>day / dayofweek / dayofyear / days_in_month / daysinmonth</li>
<li>hour / microsecond / minute / nanosecond / second</li>
<li>week / weekday / weekday_name</li>
<li>month / quarter / year / weekofyear</li>
<li>date</li>
<li>ceil / floor / round</li>
<li>normalize</li>
</ol>
</div>
<div class="section" id="your-own-functions">
<h3>Your own functions<a class="headerlink" href="#your-own-functions" title="Permalink to this headline">¶</a></h3>
<p>The sky is the limit! You can create regular Python functions and use assign to create new columns :-)</p>
<p>No need to worry about turning them into <em>pandas UDFs</em> - everything is handled by <em>HandySpark</em> under the hood!</p>
<p>The arguments of your function (or <code class="docutils literal"><span class="pre">lambda</span></code>) should have the names of the columns you want to use. For instance, to take the <code class="docutils literal"><span class="pre">log</span></code> of <code class="docutils literal"><span class="pre">Fare</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">hdf_fenced</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">logFare</span><span class="o">=</span><span class="k">lambda</span> <span class="n">Fare</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Fare</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference external image-reference" href="/images/logfare.png"><img alt="logfare" src="images/logfare.png" /></a>
<p>You can also use multiple columns:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_fenced</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">fare_times_age</span><span class="o">=</span><span class="k">lambda</span> <span class="n">Fare</span><span class="p">,</span> <span class="n">Age</span><span class="p">:</span> <span class="n">Fare</span> <span class="o">*</span> <span class="n">Age</span><span class="p">)</span>
</pre></div>
</div>
<p>Even though the result is kinda pointless, it will work :-)</p>
<p>Keep in mind that the <em>return type</em> , that is, the column type of the new column, will be the same as the first column used (<code class="docutils literal"><span class="pre">Fare</span></code>, in the example).</p>
<p>What if you want to return something of a <em>different</em> type?! No worries! You only need to <em>wrap</em> your function with the desired return type. An example should make this more clear:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span>

<span class="n">hdf_fenced</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">str_fare</span><span class="o">=</span><span class="n">StringType</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="k">lambda</span> <span class="n">Fare</span><span class="p">:</span> <span class="n">Fare</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;${:,.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)))</span>

<span class="n">hdf_fenced</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;str_fare&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<p>Basically, we imported the desired output type - <em>StringType</em> - and used its extended method <em>ret</em> to wrap our <code class="docutils literal"><span class="pre">lambda</span></code> function that formats our numeric <code class="docutils literal"><span class="pre">Fare</span></code> column into a string.</p>
<p>It is also possible to create a more complex type, like an array of doubles:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">DoubleType</span>

<span class="k">def</span> <span class="nf">make_list</span><span class="p">(</span><span class="n">Fare</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Fare</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>

<span class="n">hdf_fenced</span> <span class="o">=</span> <span class="n">hdf_fenced</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">fare_list</span><span class="o">=</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">DoubleType</span><span class="p">())</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="n">make_list</span><span class="p">))</span>

<span class="n">hdf_fenced</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;fare_list&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<p>OK, so, what happened here?</p>
<ol class="arabic simple">
<li>First, we imported the necessary types, <em>ArrayType</em> and <em>DoubleType</em> , since we are building a function that returns a list of doubles.</li>
<li>We actually built the function - notice that we call <em>apply</em> straight from <em>Fare</em> , which is treated as a pandas Series under the hood.</li>
<li>We <em>wrap</em> the function with the return type <code class="docutils literal"><span class="pre">ArrayType(DoubleType())</span></code> by invoking the extended method <code class="docutils literal"><span class="pre">ret</span></code>.</li>
<li>Finally, we assign it to a new column name, and that’s it!</li>
</ol>
</div>
<div class="section" id="nicer-exceptions">
<h3>Nicer exceptions<a class="headerlink" href="#nicer-exceptions" title="Permalink to this headline">¶</a></h3>
<p>Now, suppose you make a mistake while creating your function… if you have used Spark for a while, you already realized that, when an exception is raised, it will be <em>loooong</em> , right?</p>
<p>To help you with that, <em>HandySpark</em> analyzes the error message and parses it nicely for you at the very <em>top</em> of the error message, in <em>bold red</em> :</p>
<a class="reference external image-reference" href="/images/handy_exception.png"><img alt="exception" src="images/handy_exception.png" /></a>
</div>
<div class="section" id="safety-first">
<h3>Safety first<a class="headerlink" href="#safety-first" title="Permalink to this headline">¶</a></h3>
<p><em>HandySpark</em> wants to protect your cluster and network, so it implements a <em>safety</em> whenever you perform an operation that are going to retrieve <em>ALL</em> data from your <em>HandyFrame</em> , like <code class="docutils literal"><span class="pre">collect</span></code> or <code class="docutils literal"><span class="pre">toPandas</span></code>.</p>
<p>How does that work? Every time a <em>HandyFrame</em> has one of these methods called, it will output up to the <em>safety limit</em> , which has a default of <em>1,000 elements</em>.</p>
<a class="reference external image-reference" href="/images/safety_on.png"><img alt="safety on" src="images/safety_on.png" /></a>
<p>Do you want to set a different safety limit for your <em>HandyFrame</em> ?</p>
<a class="reference external image-reference" href="/images/safety_limit.png"><img alt="safety limit" src="images/safety_limit.png" /></a>
<p>What if you want to retrieve everything nonetheless?! You can invoke the <em>safety_off</em> method prior to the actual method you want to call and you get a <em>one-time</em> unlimited result.</p>
<a class="reference external image-reference" href="/images/safety_off.png"><img alt="safety off" src="images/safety_off.png" /></a>
</div>
<div class="section" id="don-t-feel-like-handy-anymore">
<h3>Don’t feel like Handy anymore?<a class="headerlink" href="#don-t-feel-like-handy-anymore" title="Permalink to this headline">¶</a></h3>
<p>To get back your original Spark dataframe, you only need to call <em>notHandy</em> to make it not handy again:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hdf_fenced</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="comments-questions-suggestions-bugs">
<h2>Comments, questions, suggestions, bugs<a class="headerlink" href="#comments-questions-suggestions-bugs" title="Permalink to this headline">¶</a></h2>
<p><em>DISCLAIMER</em> : this is a project <em>under development</em> , so it is likely you’ll run into bugs/problems.</p>
<p>So, if you find any bugs/problems, please open an <a class="reference external" href="https://github.com/dvgodoy/handyspark/issues">issue</a> or submit a <a class="reference external" href="https://github.com/dvgodoy/handyspark/pulls">pull request</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to HandySpark’s documentation!</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Daniel Voigt Godoy.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/includeme.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>