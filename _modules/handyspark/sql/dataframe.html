
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>handyspark.sql.dataframe &#8212; HandySpark 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for handyspark.sql.dataframe</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">handyspark.ml.base</span> <span class="k">import</span> <span class="n">HandyTransformers</span>
<span class="kn">from</span> <span class="nn">handyspark.plot</span> <span class="k">import</span> <span class="n">correlations</span><span class="p">,</span> <span class="n">histogram</span><span class="p">,</span> <span class="n">boxplot</span><span class="p">,</span> <span class="n">scatterplot</span><span class="p">,</span> <span class="n">strat_scatterplot</span><span class="p">,</span> <span class="n">strat_histogram</span><span class="p">,</span>\
    <span class="n">consolidate_plots</span><span class="p">,</span> <span class="n">post_boxplot</span>
<span class="kn">from</span> <span class="nn">handyspark.sql.pandas</span> <span class="k">import</span> <span class="n">HandyPandas</span>
<span class="kn">from</span> <span class="nn">handyspark.sql.transform</span> <span class="k">import</span> <span class="n">_MAPPING</span><span class="p">,</span> <span class="n">HandyTransform</span>
<span class="kn">from</span> <span class="nn">handyspark.util</span> <span class="k">import</span> <span class="n">HandyException</span><span class="p">,</span> <span class="n">get_buckets</span><span class="p">,</span> <span class="n">dense_to_array</span><span class="p">,</span> <span class="n">disassemble</span><span class="p">,</span> <span class="n">ensure_list</span><span class="p">,</span> <span class="n">check_columns</span><span class="p">,</span> \
    <span class="n">none2default</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">matplotlib.axes</span> <span class="k">import</span> <span class="n">Axes</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">add</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="k">import</span> <span class="n">Bucketizer</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">GroupedData</span><span class="p">,</span> <span class="n">Window</span><span class="p">,</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>

<div class="viewcode-block" id="toHandy"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.toHandy">[docs]</a><span class="k">def</span> <span class="nf">toHandy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts Spark DataFrame into HandyFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="notHandy"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.notHandy">[docs]</a><span class="k">def</span> <span class="nf">notHandy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span></div>

<span class="n">DataFrame</span><span class="o">.</span><span class="n">toHandy</span> <span class="o">=</span> <span class="n">toHandy</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">notHandy</span> <span class="o">=</span> <span class="n">notHandy</span>

<div class="viewcode-block" id="Handy"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy">[docs]</a><span class="k">class</span> <span class="nc">Handy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># classification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_classification</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nclasses</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_classes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># transformers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fenced_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># groups / strata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata_plot</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_stratification</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safety_limit</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_types</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_df&#39;</span><span class="p">,</span> <span class="s1">&#39;_strata_object&#39;</span><span class="p">,</span> <span class="s1">&#39;_strata_plot&#39;</span><span class="p">]:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">item</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;Invalid column index </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_take_array</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">strata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">strata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strata</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">strata</span><span class="p">),</span> <span class="n">res</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span><span class="p">))</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span> <span class="o">==</span> <span class="n">v</span><span class="p">,</span>
                                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">toDebugString</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)))))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">statistics_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fences_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fenced_values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_classification</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nclasses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nclasses</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nrows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strata_combinations</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stratify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strata</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HandyStrata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_stratification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata_combinations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata_clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_cols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_rows</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_set_stratification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strata</span><span class="p">,</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">clauses</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">strata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">strata</span><span class="p">),</span> <span class="s2">&quot;Mismatched number of combinations and strata!&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="o">=</span> <span class="n">strata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strata_combinations</span> <span class="o">=</span> <span class="n">combinations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strata_clauses</span> <span class="o">=</span> <span class="n">clauses</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">combinations</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">combinations</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_rows</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_build_strat_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata_plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_update_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">dataType</span><span class="o">.</span><span class="n">typeName</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;byte&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span>
                                                                            <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continuous</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_categorical</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;byte&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span>
                                                                              <span class="s1">&#39;boolan&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_string</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_take_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dataType</span><span class="o">.</span><span class="n">typeName</span><span class="p">()</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_value_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
                  <span class="o">.</span><span class="n">rdd</span>
                  <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                  <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">sortBy</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">__fill_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;Target must be a DataFrame&quot;</span>
        <span class="n">joined_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fill_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">strat_df</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">joined_df</span> <span class="o">=</span> <span class="n">strat_df</span> <span class="k">if</span> <span class="n">joined_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">unionAll</span><span class="p">(</span><span class="n">strat_df</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clauses</span><span class="p">):</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;not (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">clauses</span><span class="p">))))</span>
            <span class="n">joined_df</span> <span class="o">=</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">unionAll</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">fill_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">joined_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">joined_df</span> <span class="o">=</span> <span class="n">target</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">joined_df</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">fill_dict</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_fill_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_means</span><span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                     <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">continuous</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)))]))</span>
        <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_medians</span><span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                       <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">continuous</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)))]))</span>
        <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorical</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">__fill_self</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
        <span class="n">continuous</span> <span class="o">=</span> <span class="n">none2default</span><span class="p">(</span><span class="n">continuous</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">categorical</span> <span class="o">=</span> <span class="n">none2default</span><span class="p">(</span><span class="n">categorical</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">continuous</span> <span class="o">+</span> <span class="n">categorical</span><span class="p">)</span>

        <span class="n">strategy</span> <span class="o">=</span> <span class="n">none2default</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">continuous</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continuous</span>
        <span class="k">if</span> <span class="n">categorical</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">categorical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorical</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">continuous</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">strategy</span><span class="p">),</span> <span class="s2">&quot;There must be a strategy to each column.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="p">[</span><span class="n">strategy</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">continuous</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_values</span><span class="p">(</span><span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_dense_to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">array_colname</span><span class="p">):</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dense_to_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">(),</span> <span class="n">colname</span><span class="p">,</span> <span class="n">array_colname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Handy.disassemble"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.disassemble">[docs]</a>    <span class="k">def</span> <span class="nf">disassemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">new_colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">disassemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">(),</span> <span class="n">colname</span><span class="p">,</span> <span class="n">new_colnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handy.to_metrics_RDD"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.to_metrics_RDD">[docs]</a>    <span class="k">def</span> <span class="nf">to_metrics_RDD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob_col</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="p">[</span><span class="n">prob_col</span><span class="p">,</span> <span class="n">label</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disassemble</span><span class="p">(</span><span class="n">prob_col</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prob_col</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handy.fill"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.fill">[docs]</a>    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fill_target</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fill_self</span><span class="p">(</span><span class="n">continuous</span><span class="o">=</span><span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="n">categorical</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handy.isnull"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.isnull">[docs]</a>    <span class="k">def</span> <span class="nf">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;missing&#39;</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrows</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_counts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ratio</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">nrows</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;(ratio)&#39;</span>
            <span class="n">missing</span> <span class="o">/=</span> <span class="n">base</span>
        <span class="n">missing</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">missing</span></div>

<div class="viewcode-block" id="Handy.outliers"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.outliers">[docs]</a>    <span class="k">def</span> <span class="nf">outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;tukey&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">none2default</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;tukey&#39;</span><span class="p">:</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;25%&#39;</span><span class="p">,</span> <span class="n">colname</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;75%&#39;</span><span class="p">,</span> <span class="n">colname</span><span class="p">]</span>
                <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
                <span class="n">lfence</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">iqr</span><span class="p">)</span>
                <span class="n">ufence</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">iqr</span><span class="p">)</span>
                <span class="n">outliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">lfence</span><span class="p">,</span> <span class="n">ufence</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">ratio</span><span class="p">:</span>
                    <span class="n">outliers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_counts</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">outliers</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">colnames</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Handy.nunique"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.nunique">[docs]</a>    <span class="k">def</span> <span class="nf">nunique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">none2default</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">],</span>
                         <span class="n">index</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handy.fence"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.fence">[docs]</a>    <span class="k">def</span> <span class="nf">fence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">approxQuantile</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">colname</span><span class="p">,</span> <span class="n">probabilities</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span> <span class="o">.</span><span class="mi">75</span><span class="p">],</span> <span class="n">relativeError</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
            <span class="n">lfence</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">iqr</span><span class="p">)</span>
            <span class="n">ufence</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">iqr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fenced_values</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">colname</span><span class="p">:</span> <span class="p">[</span><span class="n">lfence</span><span class="p">,</span> <span class="n">ufence</span><span class="p">]})</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span>
                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;__fence&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">lfence</span><span class="p">))</span>
                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">greatest</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="s1">&#39;__fence&#39;</span><span class="p">))</span>
                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;__fence&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">ufence</span><span class="p">))</span>
                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">least</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="s1">&#39;__fence&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handy.set_response"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.set_response">[docs]</a>    <span class="k">def</span> <span class="nf">set_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">colname</span>
        <span class="k">if</span> <span class="n">colname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continuous</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_classification</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nclasses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_classes</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Handy.value_counts"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.value_counts">[docs]</a>    <span class="k">def</span> <span class="nf">value_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_counts</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">dropna</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">values</span><span class="p">),</span>
                         <span class="n">index</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">),</span>
                         <span class="n">name</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handy.mode"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.mode">[docs]</a>    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value_counts</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handy.corr"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.corr">[docs]</a>    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">none2default</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">])</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">(),</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pdf</span></div>

<div class="viewcode-block" id="Handy.mean"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="Handy.min"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="Handy.max"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="Handy.median"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.median">[docs]</a>    <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="Handy.stddev"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.stddev">[docs]</a>    <span class="k">def</span> <span class="nf">stddev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;stddev&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="Handy.var"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.var">[docs]</a>    <span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;stddev&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span></div>

<div class="viewcode-block" id="Handy.q1"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.q1">[docs]</a>    <span class="k">def</span> <span class="nf">q1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;25%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="Handy.q3"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.q3">[docs]</a>    <span class="k">def</span> <span class="nf">q3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="s1">&#39;75%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

    <span class="c1">### Boxplot functions</span>
    <span class="k">def</span> <span class="nf">_strat_boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">kwds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;showfliers&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_rows</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_strat_plot</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Handy.boxplot"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.boxplot">[docs]</a>    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showfliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span> <span class="s2">&quot;Only numerical columns can be plot!&quot;</span>
        <span class="k">return</span> <span class="n">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">showfliers</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_post_boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">post_boxplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strata_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata_clauses</span><span class="p">)</span>

    <span class="c1">### Scatterplot functions</span>
    <span class="k">def</span> <span class="nf">_strat_scatterplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_strat_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_cols</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strat_scatterplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">(),</span> <span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="Handy.scatterplot"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.scatterplot">[docs]</a>    <span class="k">def</span> <span class="nf">scatterplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;There must be two columns to plot!&quot;</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numerical</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Both columns must be numerical!&quot;</span>
        <span class="k">return</span> <span class="n">scatterplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span></div>

    <span class="c1">### Histogram functions</span>
    <span class="k">def</span> <span class="nf">_strat_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_strat_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_cols</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">categorical</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continuous</span><span class="p">:</span>
            <span class="n">categorical</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">strat_histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">(),</span> <span class="n">colname</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">categorical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="Handy.hist"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Handy.hist">[docs]</a>    <span class="k">def</span> <span class="nf">hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># TO DO</span>
        <span class="c1"># include split per response/columns</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensure_list</span><span class="p">(</span><span class="n">colname</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Only single columns can be plot!&quot;</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continuous</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HandyGrouped"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyGrouped">[docs]</a><span class="k">class</span> <span class="nc">HandyGrouped</span><span class="p">(</span><span class="n">GroupedData</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jgd</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jgd</span> <span class="o">=</span> <span class="n">jgd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sql_ctx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cols</span> <span class="o">=</span> <span class="n">args</span>

<div class="viewcode-block" id="HandyGrouped.agg"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyGrouped.agg">[docs]</a>    <span class="k">def</span> <span class="nf">agg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exprs</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="o">*</span><span class="n">exprs</span><span class="p">)</span>
        <span class="n">handy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_handy</span><span class="p">)</span>
        <span class="n">handy</span><span class="o">.</span><span class="n">_group_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols</span>
        <span class="k">return</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">handy</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;HandyGrouped[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_cols</span><span class="p">))</span></div>


<div class="viewcode-block" id="HandyFrame"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame">[docs]</a><span class="k">class</span> <span class="nc">HandyFrame</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HandySpark version of DataFrame.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cols: HandyColumns</span>
<span class="sd">        class to access pandas-like column based methods implemented in Spark</span>
<span class="sd">    pandas: HandyPandas</span>
<span class="sd">        class to access pandas-like column based methods through pandas UDFs</span>
<span class="sd">    transformers: HandyTransformers</span>
<span class="sd">        class to generate Handy transformers</span>
<span class="sd">    stages: integer</span>
<span class="sd">        number of stages in the execution plan</span>
<span class="sd">    response: string</span>
<span class="sd">        name of the response column</span>
<span class="sd">    is_classification: boolean</span>
<span class="sd">        True if response is a categorical variable</span>
<span class="sd">    classes: list</span>
<span class="sd">        list of classes for a classification problem</span>
<span class="sd">    nclasses: integer</span>
<span class="sd">        number of classes for a classification problem</span>
<span class="sd">    ncols: integer</span>
<span class="sd">        number of columns of the HandyFrame</span>
<span class="sd">    nrows: integer</span>
<span class="sd">        number of rows of the HandyFrame</span>
<span class="sd">    shape: tuple</span>
<span class="sd">        tuple representing dimensionality of the HandyFrame</span>
<span class="sd">    statistics_: dict</span>
<span class="sd">        imputation fill value for each feature</span>
<span class="sd">        If stratified, first level keys are filter clauses for stratification</span>
<span class="sd">    fences_: dict</span>
<span class="sd">        fence values for each feature</span>
<span class="sd">        If stratified, first level keys are filter clauses for stratification</span>
<span class="sd">    is_stratified: boolean</span>
<span class="sd">        True if HandyFrame was stratified</span>
<span class="sd">    values: ndarray</span>
<span class="sd">        Numpy representation of HandyFrame.</span>

<span class="sd">    Available methods:</span>
<span class="sd">    - notHandy: makes it a plain Spark dataframe</span>
<span class="sd">    - stratify: used to perform stratified operations</span>
<span class="sd">    - isnull: checks for missing values</span>
<span class="sd">    - fill: fills missing values</span>
<span class="sd">    - outliers: checks for outliers</span>
<span class="sd">    - fence: fences outliers</span>
<span class="sd">    - set_safety_limit: defines new safety limit for collect operations</span>
<span class="sd">    - safety_off: disables safety limit for a single operation</span>
<span class="sd">    - assign: appends a new columns based on an expression</span>
<span class="sd">    - nunique: returns number of unique values in each column</span>
<span class="sd">    - set_response: sets column to be used as response / label</span>
<span class="sd">    - disassemble: turns a vector / array column into multiple columns</span>
<span class="sd">    - to_metrics_RDD: turns probability and label columns into a tuple RDD</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">handy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">_jdf</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handy</span> <span class="o">=</span> <span class="n">Handy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">handy</span><span class="p">)</span>
            <span class="n">handy</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">handy</span><span class="o">.</span><span class="n">_update_types</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span> <span class="o">=</span> <span class="n">handy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_safety</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safety_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_safety_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__overriden</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;collect&#39;</span><span class="p">,</span> <span class="s1">&#39;take&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strat_handy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strat_index</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_means</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_medians</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summaries</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__overriden</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">HandyException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HandyException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">summary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HandyException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;notHandy&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">HandyFrame</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">GroupedData</span><span class="p">):</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">HandyGrouped</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">_jgd</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">return</span> <span class="n">wrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attr</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;HandyFrame[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_strata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_handy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_handy</span><span class="o">.</span><span class="n">_strata_object</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="nb">object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">object</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_handy</span><span class="o">.</span><span class="n">_strata_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">plot</span> <span class="o">=</span> <span class="n">plots</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_strat_index</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">plot</span><span class="p">,</span> <span class="nb">object</span>

    <span class="k">def</span> <span class="nf">_gen_row_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># EXPERIMENTAL - DO NOT USE!</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span>
                <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;_miid&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">monotonically_increasing_id</span><span class="p">())</span>
                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;_row_id&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;_miid&#39;</span><span class="p">))))</span>
                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_miid&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">):</span>
        <span class="c1"># EXPERIMENTAL - DO NOT USE!</span>
        <span class="k">assert</span> <span class="s1">&#39;_row_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;Cannot use LOC without generating `row_id`s first!&quot;</span>
        <span class="n">clause</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;_row_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_numerical</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_continuous</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_medians</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;50%&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_continuous</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">statistic</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_numerical</span><span class="p">]</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">statistic</span><span class="p">,</span> <span class="n">colnames</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a class to access pandas-like column based methods implemented in Spark</span>

<span class="sd">        Available methods:</span>
<span class="sd">        - min</span>
<span class="sd">        - max</span>
<span class="sd">        - median</span>
<span class="sd">        - q1</span>
<span class="sd">        - q3</span>
<span class="sd">        - stddev</span>
<span class="sd">        - value_counts</span>
<span class="sd">        - mode</span>
<span class="sd">        - corr</span>
<span class="sd">        - nunique</span>
<span class="sd">        - hist</span>
<span class="sd">        - boxplot</span>
<span class="sd">        - scatterplot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HandyColumns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a class to access pandas-like column based methods through pandas UDFs</span>

<span class="sd">        Available methods:</span>
<span class="sd">        - betweeen / between_time</span>
<span class="sd">        - isin</span>
<span class="sd">        - isna / isnull</span>
<span class="sd">        - notna / notnull</span>
<span class="sd">        - abs</span>
<span class="sd">        - clip / clip_lower / clip_upper</span>
<span class="sd">        - replace</span>
<span class="sd">        - round / truncate</span>
<span class="sd">        - tz_convert / tz_localize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HandyPandas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a class to generate Handy transformers</span>

<span class="sd">        Available transformers:</span>
<span class="sd">        - HandyImputer</span>
<span class="sd">        - HandyFencer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HandyTransformers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of stages in the execution plan.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">stages</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of the response column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">response</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if response is a categorical variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">is_classification</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of classes for a classification problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">classes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nclasses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of classes for a classification problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">nclasses</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of columns of the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">ncols</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nrows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of rows of the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">nrows</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a tuple representing the dimensionality of the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">statistics_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns dictionary with imputation fill value for each feature.</span>
<span class="sd">        If stratified, first level keys are filter clauses for stratification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">statistics_</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fences_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns dictionary with fence values for each feature.</span>
<span class="sd">        If stratified, first level keys are filter clauses for stratification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">fences_</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Numpy representation of HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># safety limit will kick in, unless explicitly off before</span>
        <span class="n">tdf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safety</span><span class="p">:</span>
            <span class="n">tdf</span> <span class="o">=</span> <span class="n">tdf</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_safety_limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>

<div class="viewcode-block" id="HandyFrame.notHandy"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.notHandy">[docs]</a>    <span class="k">def</span> <span class="nf">notHandy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts HandyFrame back into Spark&#39;s DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.set_safety_limit"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.set_safety_limit">[docs]</a>    <span class="k">def</span> <span class="nf">set_safety_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets safety limit used for ``collect`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_safety_limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safety_limit</span> <span class="o">=</span> <span class="n">limit</span></div>

<div class="viewcode-block" id="HandyFrame.safety_off"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.safety_off">[docs]</a>    <span class="k">def</span> <span class="nf">safety_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disables safety limit for a single call of ``collect`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="HandyFrame.collect"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns all the records as a list of :class:`Row`.</span>

<span class="sd">        By default, its output is limited by the safety limit.</span>
<span class="sd">        To get original `collect` behavior, call ``safety_off`` method first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safety</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: Safety is ON - returning up to </span><span class="si">{}</span><span class="s1"> instances.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_safety_limit</span><span class="p">))</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_safety_limit</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">res</span>
        <span class="k">except</span> <span class="n">HandyException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HandyException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">summary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HandyException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.take"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.take">[docs]</a>    <span class="k">def</span> <span class="nf">take</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the first ``num`` rows as a :class:`list` of :class:`Row`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="HandyFrame.stratify"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.stratify">[docs]</a>    <span class="k">def</span> <span class="nf">stratify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stratify the HandyFrame.</span>

<span class="sd">        Stratified operations should be more efficient than group by operations, as they</span>
<span class="sd">        rely on three iterative steps, namely: filtering the underlying HandyFrame, performing</span>
<span class="sd">        the operation and aggregating the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strata</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_stratify</span><span class="p">(</span><span class="n">strata</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.transform"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;INTERNAL USE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HandyTransform</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="n">returnType</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.apply"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;INTERNAL USE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HandyTransform</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="n">returnType</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.assign"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign new columns to a HandyFrame, returning a new object (a copy)</span>
<span class="sd">        with all the original columns in addition to the new ones.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : keyword, value pairs</span>
<span class="sd">            keywords are the column names.</span>
<span class="sd">            If the values are callable, they are computed on the DataFrame and</span>
<span class="sd">            assigned to the new columns.</span>
<span class="sd">            If the values are not callable, (e.g. a scalar, or string),</span>
<span class="sd">            they are simply assigned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : HandyFrame</span>
<span class="sd">            A new HandyFrame with the new columns in addition to</span>
<span class="sd">            all the existing columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HandyTransform</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.isnull"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.isnull">[docs]</a>    <span class="k">def</span> <span class="nf">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns array with counts of missing value for each column in the HandyFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ratio: boolean, default False</span>
<span class="sd">            If True, returns ratios instead of absolute counts.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        counts: Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.nunique"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.nunique">[docs]</a>    <span class="k">def</span> <span class="nf">nunique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Series with number of distinct observations for all columns.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nunique: Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">nunique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.outliers"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.outliers">[docs]</a>    <span class="k">def</span> <span class="nf">outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;tukey&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Series with number of outlier observations according to</span>
<span class="sd">         the specified method for all columns.</span>

<span class="sd">         Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">         ratio: boolean, optional</span>
<span class="sd">            If True, returns proportion instead of counts.</span>
<span class="sd">            Default is True.</span>
<span class="sd">         method: string, optional</span>
<span class="sd">            Method used to detect outliers. Currently, only Tukey&#39;s method is supported.</span>
<span class="sd">            Default is tukey.</span>

<span class="sd">         Returns</span>
<span class="sd">         -------</span>
<span class="sd">         outliers: Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">outliers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.set_response"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.set_response">[docs]</a>    <span class="k">def</span> <span class="nf">set_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets column to be used as response in supervised learning algorithms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        colname: string</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">set_response</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.fill"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.fill">[docs]</a>    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill NA/NaN values using the specified methods.</span>

<span class="sd">        The values used for imputation are kept in ``statistics_`` property</span>
<span class="sd">        and can later be used to generate a corresponding HandyImputer transformer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        categorical: &#39;all&#39; or list of string, optional</span>
<span class="sd">            List of categorical columns.</span>
<span class="sd">            These columns are filled with its coresponding modes (most common values).</span>
<span class="sd">        continuous: &#39;all&#39; or list of string, optional</span>
<span class="sd">            List of continuous value columns.</span>
<span class="sd">            By default, these columns are filled with its  corresponding means.</span>
<span class="sd">            If a same-sized list is provided in the ``strategy`` argument, it uses</span>
<span class="sd">            the corresponding straegy for each column.</span>
<span class="sd">        strategy: list of string, optional</span>
<span class="sd">            If informed, it must contain a strategy - either ``mean`` or ``median`` - for</span>
<span class="sd">            each one of the continuous columns.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : HandyFrame</span>
<span class="sd">            A new HandyFrame with filled missing values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="n">categorical</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.fence"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.fence">[docs]</a>    <span class="k">def</span> <span class="nf">fence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Caps outliers using lower and upper fences given by Tukey&#39;s method,</span>
<span class="sd">        using 1.5 times the interquartile range (IQR).</span>

<span class="sd">        The fence values used for capping outliers are kept in ``fences_`` property</span>
<span class="sd">        and can later be used to generate a corresponding HandyFencer transformer.</span>

<span class="sd">        For more information, check: https://en.wikipedia.org/wiki/Outlier#Tukey&#39;s_fences</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        colnames: list of string</span>
<span class="sd">            Column names to apply fencing.</span>
<span class="sd">        k: float, optional</span>
<span class="sd">            Constant multiplier for the IQR.</span>
<span class="sd">            Default is 1.5 (corresponding to Tukey&#39;s outlier, use 3 for &quot;far out&quot; values)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : HandyFrame</span>
<span class="sd">            A new HandyFrame with capped outliers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">fence</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.disassemble"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.disassemble">[docs]</a>    <span class="k">def</span> <span class="nf">disassemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">new_colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disassembles a Vector or Array column into multiple columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        colname: string</span>
<span class="sd">            Column containing Vector or Array elements.</span>
<span class="sd">        new_colnames: list of string, optional</span>
<span class="sd">            Default is None, column names are generated using a sequentially</span>
<span class="sd">            generated suffix (e.g., _0, _1, etc.) for ``colname``.</span>
<span class="sd">            If informed, it must have as many column names as elements</span>
<span class="sd">            in the shortest vector/array of ``colname``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : HandyFrame</span>
<span class="sd">            A new HandyFrame with the new disassembled columns in addition to</span>
<span class="sd">            all the existing columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">disassemble</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">new_colnames</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyFrame.to_metrics_RDD"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyFrame.to_metrics_RDD">[docs]</a>    <span class="k">def</span> <span class="nf">to_metrics_RDD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob_col</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a DataFrame containing predicted probabilities and classification labels</span>
<span class="sd">        into a RDD suited for use with ``BinaryClassificationMetrics`` object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prob_col: string, optional</span>
<span class="sd">            Column containing Vectors of probabilities.</span>
<span class="sd">            Default is &#39;probability&#39;.</span>
<span class="sd">        label_col: string, optional</span>
<span class="sd">            Column containing labels.</span>
<span class="sd">            Default is &#39;label&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdd: RDD</span>
<span class="sd">            RDD of tuples (probability, label)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">to_metrics_RDD</span><span class="p">(</span><span class="n">prob_col</span><span class="p">,</span> <span class="n">label_col</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Bucket"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Bucket">[docs]</a><span class="k">class</span> <span class="nc">Bucket</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bucketizes a column of continuous values into equal sized bins</span>
<span class="sd">    to perform stratification.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    colname: string</span>
<span class="sd">        Column containing continuous values</span>
<span class="sd">    bins: integer</span>
<span class="sd">        Number of equal sized bins to map original values to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bucket: Bucket</span>
<span class="sd">        Bucket object to be used as column in stratification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colname</span> <span class="o">=</span> <span class="n">colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bins</span> <span class="o">=</span> <span class="n">bins</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Bucket_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bins</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">colname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colname</span>

    <span class="k">def</span> <span class="nf">_get_buckets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">check_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">)</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="p">([</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">+</span>
                   <span class="n">get_buckets</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bins</span><span class="p">)</span> <span class="o">+</span>
                   <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)])</span>
        <span class="n">buckets</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1e-14</span>
        <span class="k">return</span> <span class="n">buckets</span>

    <span class="k">def</span> <span class="nf">_get_clauses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buckets</span><span class="p">):</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">,</span> <span class="n">buckets</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">buckets</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">buckets</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &gt;= </span><span class="si">{:.4f}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="n">clauses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">clauses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">)</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &gt; </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">,</span> <span class="n">buckets</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">clauses</span></div>


<div class="viewcode-block" id="Quantile"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.Quantile">[docs]</a><span class="k">class</span> <span class="nc">Quantile</span><span class="p">(</span><span class="n">Bucket</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bucketizes a column of continuous values into quantiles</span>
<span class="sd">    to perform stratification.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    colname: string</span>
<span class="sd">        Column containing continuous values</span>
<span class="sd">    bins: integer</span>
<span class="sd">        Number of quantiles to map original values to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    quantile: Quantile</span>
<span class="sd">        Quantile object to be used as column in stratification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Quantile</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bins</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_buckets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="p">([</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">+</span>
                   <span class="n">df</span><span class="o">.</span><span class="n">approxQuantile</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_colname</span><span class="p">,</span>
                                     <span class="n">probabilities</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                     <span class="n">relativeError</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">+</span>
                   <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)])</span>
        <span class="n">buckets</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1e-14</span>
        <span class="k">return</span> <span class="n">buckets</span></div>


<div class="viewcode-block" id="HandyColumns"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns">[docs]</a><span class="k">class</span> <span class="nc">HandyColumns</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HandyColumn(s) in a HandyFrame.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    numerical: list of string</span>
<span class="sd">        List of numerical columns (integer, float, double)</span>
<span class="sd">    categorical: list of string</span>
<span class="sd">        List of categorical columns (string, integer)</span>
<span class="sd">    continuous: list of string</span>
<span class="sd">        List of continous columns (float, double)</span>
<span class="sd">    string: list of string</span>
<span class="sd">        List of string columns (string)</span>
<span class="sd">    array: list of string</span>
<span class="sd">        List of array columns (array, map)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">handy</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span> <span class="o">=</span> <span class="n">handy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="o">=</span> <span class="n">strata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COLTYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;continuous&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous</span><span class="p">,</span>
                         <span class="s1">&#39;categorical&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span>
                         <span class="s1">&#39;numerical&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numerical</span><span class="p">,</span>
                         <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                         <span class="s1">&#39;array&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># try it as an alias</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLTYPES</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="n">check_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="o">=</span> <span class="n">item</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_group_cols</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_group_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;Invalid column index </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">notHandy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_safety</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: Safety is ON - returning up to </span><span class="si">{}</span><span class="s1"> instances.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_safety_limit</span><span class="p">))</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_safety_limit</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_safety</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="n">res</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># try it as an alias</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLTYPES</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="o">.</span><span class="n">_handycolumns</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;HandyColumns[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">numerical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of numerical columns in the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_numerical</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of categorical columns in the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_categorical</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of continuous columns in the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_continuous</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of string columns in the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_string</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of array or map columns in the HandyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_array</span>

<div class="viewcode-block" id="HandyColumns.mean"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="HandyColumns.min"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="HandyColumns.max"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="HandyColumns.median"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.median">[docs]</a>    <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="HandyColumns.stddev"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.stddev">[docs]</a>    <span class="k">def</span> <span class="nf">stddev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;stddev&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="HandyColumns.var"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.var">[docs]</a>    <span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;stddev&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span></div>

<div class="viewcode-block" id="HandyColumns.q1"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.q1">[docs]</a>    <span class="k">def</span> <span class="nf">q1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;25%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="HandyColumns.q3"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.q3">[docs]</a>    <span class="k">def</span> <span class="nf">q3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="s1">&#39;75%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>

<div class="viewcode-block" id="HandyColumns.value_counts"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.value_counts">[docs]</a>    <span class="k">def</span> <span class="nf">value_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns object containing counts of unique values.</span>

<span class="sd">        The resulting object will be in descending order so that the</span>
<span class="sd">        first element is the most frequently-occurring element.</span>
<span class="sd">        Excludes NA values by default.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dropna : boolean, default True</span>
<span class="sd">            Don&#39;t include counts of missing values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        counts: Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensure_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;A single column must be selected!&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="n">dropna</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyColumns.mode"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.mode">[docs]</a>    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns same-type modal (most common) value for each column.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mode: Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">)</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyColumns.corr"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.corr">[docs]</a>    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute pairwise correlation of columns, excluding NA/null values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : {&#39;pearson&#39;, &#39;spearman&#39;}</span>
<span class="sd">            * pearson : standard correlation coefficient</span>
<span class="sd">            * spearman : Spearman rank correlation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y : DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">numerical</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyColumns.nunique"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.nunique">[docs]</a>    <span class="k">def</span> <span class="nf">nunique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Series with number of distinct observations for specified columns.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nunique: Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">nunique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyColumns.outliers"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.outliers">[docs]</a>    <span class="k">def</span> <span class="nf">outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;tukey&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Series with number of outlier observations according to</span>
<span class="sd">         the specified method for all columns.</span>

<span class="sd">         Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">         ratio: boolean, optional</span>
<span class="sd">            If True, returns proportion instead of counts.</span>
<span class="sd">            Default is True.</span>
<span class="sd">         method: string, optional</span>
<span class="sd">            Method used to detect outliers. Currently, only Tukey&#39;s method is supported.</span>
<span class="sd">            Default is tukey.</span>

<span class="sd">         Returns</span>
<span class="sd">         -------</span>
<span class="sd">         outliers: Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">outliers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyColumns.hist"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.hist">[docs]</a>    <span class="k">def</span> <span class="nf">hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draws histogram of the HandyFrame&#39;s column using matplotlib / pylab.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bins : integer, default 10</span>
<span class="sd">            Number of histogram bins to be used</span>
<span class="sd">        ax : matplotlib axes object, default None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyColumns.boxplot"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.boxplot">[docs]</a>    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showfliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a box plot from HandyFrame column.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : matplotlib axes object, default None</span>
<span class="sd">        showfliers : bool, optional (True)</span>
<span class="sd">            Show the outliers beyond the caps.</span>
<span class="sd">        k: float, optional</span>
<span class="sd">            Constant multiplier for the IQR.</span>
<span class="sd">            Default is 1.5 (corresponding to Tukey&#39;s outlier, use 3 for &quot;far out&quot; values)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">showfliers</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="HandyColumns.scatterplot"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyColumns.scatterplot">[docs]</a>    <span class="k">def</span> <span class="nf">scatterplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a scatter plot of two HandyFrame columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : matplotlib axes object, default None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HandyStrata"><a class="viewcode-back" href="../../../handyspark.sql.html#handyspark.HandyStrata">[docs]</a><span class="k">class</span> <span class="nc">HandyStrata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__handy_methods</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span>
                               <span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                    <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">HandyFrame</span><span class="p">,</span>
                                                       <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">HandyColumns</span><span class="p">,</span>
                                                       <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">))))))</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;handy&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handy</span><span class="p">,</span> <span class="n">strata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span> <span class="o">=</span> <span class="n">handy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">handy</span><span class="o">.</span><span class="n">_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span> <span class="o">=</span> <span class="n">strata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col_clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">temp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">:</span>
            <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Bucket</span><span class="p">):</span>
                <span class="n">buckets</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">_get_buckets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>
                <span class="n">clauses</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">_get_clauses</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
                <span class="n">bucketizer</span> <span class="o">=</span> <span class="n">Bucketizer</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="n">buckets</span><span class="p">,</span> <span class="n">inputCol</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">colname</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
                <span class="n">temp_df</span> <span class="o">=</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">bucketizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">temp_df</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_col_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>

        <span class="n">combinations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">temp_df</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_value_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colnames</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combinations</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">value</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span> <span class="k">else</span> <span class="n">clauses</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
                                    <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">clauses</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_clauses</span><span class="p">))</span>
                              <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clauses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Bucket</span><span class="p">)</span>
                                      <span class="k">else</span>  <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> == &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">),</span>
                                                                <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">,</span> <span class="n">comb</span><span class="p">))</span>
                         <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combinations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strat_df</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span> <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clauses</span><span class="p">]</span>

        <span class="c1"># Shares the same HANDY object among all sub dataframes</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strat_df</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">_strat_index</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">df</span><span class="o">.</span><span class="n">_strat_handy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handycolumns</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s2">&quot;HandyStrata[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handycolumns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handycolumns</span><span class="p">)</span>
            <span class="nb">repr</span> <span class="o">=</span> <span class="s2">&quot;HandyColumns[</span><span class="si">%s</span><span class="s2">] by </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">),</span> <span class="nb">repr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">repr</span>

    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;cols&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HandyColumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">attr</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handy_methods</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Makes stratification</span>
                        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_df</span><span class="p">:</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_strata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_set_stratification</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combinations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clauses</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handycolumns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handycolumns</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">attr_strata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="p">,</span> <span class="s1">&#39;_strat_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_strata_object</span> <span class="o">=</span> <span class="n">attr_strata</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handycolumns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">_handy</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_df</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_df</span><span class="p">]</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">attr_post</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="p">,</span> <span class="s1">&#39;_post_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">attr_post</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="n">strata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">strata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()))</span>
                        <span class="n">strata_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">colname</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strata</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DataFrame</span><span class="p">):</span>
                            <span class="n">joined_df</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span> <span class="o">=</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">statistics_</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_fenced_values</span> <span class="o">=</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">fences_</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_df</span><span class="o">.</span><span class="n">statistics_</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">statistics_</span><span class="p">}</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_df</span><span class="o">.</span><span class="n">fences_</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_fenced_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">fences_</span><span class="p">}</span>
                                <span class="k">for</span> <span class="n">strat_df</span><span class="p">,</span> <span class="n">clause</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clauses</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_df</span><span class="o">.</span><span class="n">statistics_</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">clause</span><span class="p">:</span> <span class="n">strat_df</span><span class="o">.</span><span class="n">statistics_</span><span class="p">})</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_df</span><span class="o">.</span><span class="n">fences_</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_fenced_values</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">clause</span><span class="p">:</span> <span class="n">strat_df</span><span class="o">.</span><span class="n">fences_</span><span class="p">})</span>
                                    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">unionAll</span><span class="p">(</span><span class="n">strat_df</span><span class="p">)</span>
                                <span class="c1"># Clears stratification</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_clear_stratification</span><span class="p">()</span>

                                <span class="n">res</span> <span class="o">=</span> <span class="n">HandyFrame</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="p">)</span>
                                <span class="n">res</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_imputed_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imputed_values</span>
                                <span class="n">res</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_fenced_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fenced_values</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                            <span class="n">strat_res</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">indexes</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
                            <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">strata</span><span class="p">):</span>
                                <span class="n">strata_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="o">.</span><span class="n">colname</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                                <span class="n">strat_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="n">strata_dict</span><span class="p">)</span>
                                                 <span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">strat_res</span><span class="p">)</span>
                                   <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">strata_cols</span><span class="p">)</span>
                                   <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">strata_cols</span> <span class="o">+</span> <span class="n">indexes</span><span class="p">)</span>
                                   <span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                            <span class="n">strat_res</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">strata</span><span class="p">):</span>
                                <span class="n">strata_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="o">.</span><span class="n">colname</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                                <span class="n">series_name</span> <span class="o">=</span> <span class="n">none2default</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">series_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                                    <span class="n">series_name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
                                <span class="n">strat_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                                                 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">series_name</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">series_name</span><span class="p">})</span>
                                                 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="n">strata_dict</span><span class="p">)</span>
                                                 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">strata_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">series_name</span><span class="p">])[</span><span class="n">name</span><span class="p">])</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">strat_res</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensure_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handycolumns</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                                                   <span class="n">index</span><span class="o">=</span><span class="n">strata_cols</span><span class="p">,</span>
                                                                                   <span class="n">columns</span><span class="o">=</span><span class="n">series_name</span><span class="p">)</span>
                                    <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                            <span class="c1"># TO TEST</span>
                            <span class="n">strat_res</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">strata</span><span class="p">):</span>
                                <span class="n">strata_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="o">.</span><span class="n">colname</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                                <span class="n">strat_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                                                 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="n">strata_dict</span><span class="p">)</span>
                                                 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">strata_cols</span><span class="p">)[</span><span class="n">name</span><span class="p">])</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">strat_res</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Axes</span><span class="p">):</span>
                            <span class="n">res</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_strata_plot</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">consolidate_plots</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clauses</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">joined_list</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                                <span class="n">joined_list</span> <span class="o">+=</span> <span class="n">l</span>
                            <span class="k">return</span> <span class="n">joined_list</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_combinations</span><span class="p">):</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
                                              <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">strata</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">strata_cols</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                   <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">strata_cols</span><span class="p">)</span>
                                   <span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
                        <span class="k">return</span> <span class="n">res</span>
                    <span class="k">except</span> <span class="n">HandyException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HandyException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">summary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HandyException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_handy</span><span class="o">.</span><span class="n">_clear_stratification</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">wrapper</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Daniel Voigt Godoy.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>